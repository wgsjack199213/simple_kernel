#### Dune: Safe User-level Access to Privileged CPU Features阅读笔记

利用CPU的特权指令可以使应用程序得以实现一系列有价值的功能。例如加速垃圾收集，特权隔离，沙盒隔离。

常见的实现方式是修改内核（但是太麻烦了，而且多处修改容易引发问题），和虚拟机（集成性差，开销大，guest OS实现繁琐）。

本文借助硬件虚拟化的技术(Intel VT-x Extension)，设计实现了一个操作系统Dune，对于进程，而不是机器，进行了一层抽象，使得在用户态就可以安全地访问CPU的特权功能（使用特权指令），例如虚存寄存器，中断，异常，系统调用向量，页表等相关的指令。Dune设计的根本目的是既扩展应用功能（特权指令 ），又提高性能，同时保持安全性。

作者举了个例子，利用VT-x机制，发生异常时就不必再进行特权级转换和upcall了，Dune可以直接将exception交由硬件处理。软件的overhead因此得以减小。（timer interrupt等中断还是会触发VM exit，由内核处理。）

访存方面隔离的主要机制是利用VY-x提供的EPT（拓展页表），实现了内存的隔离。guest OS只能访问EPT，不能访问（普通）页表。所以这样Dune用户进程的地址转换要经过两次，第一次：用户虚拟地址通过用户页表转换为guest OS的“物理”地址，第二次：guest OS的物理地址通过EPT转换得到实际物理宿主机器的物理内存地址。EPT的配置由Kenel完成。

- 这样两层内存地址转换开销较大，在运行内存密集型任务时，可能会对性能有负面影响。这也是实验部分Figure 3中，用SPEC2000做实验时，有两项表现性能明显较差的原因。作者们为了改善这个问题，使用了更大的页表（这样地址转换次数就减少了），性能得到了明显优化。

- 为什么不直接将EPT指向普通的PT？作者解答说有两个问题，一是EPT的二进制文件格式和标准x86页表格式不一样，二是Intel x86处理器限制了guest-physical地址长度为host-physical地址长度。

系统架构方面，Dune Process运行在VMX non-root态，ring 0特权级。它向下和kernel上的Dune Module进行交互，向上给应用程序提供libDune，封装编程接口。

实现上虽然libDune代码量不小（6000），但应用程序开发起来不麻烦，调用libDune封装的接口即可。

在实验评测方面，主要实验的指标是几个基本函数、几个案例应用的执行时间。Dune表现出了更优的执行性能。

这个文章的创作思路应该是先研究了VT-x虚拟化技术的功能（可以提供哪些特权指令），然后设计了Kernel产生Dune Process，通过增加了一层Dune Process抽象来运行应用的架构（模式），同时构思了（或引用了其他研究中的）一系列的应用（可以从使用特权指令中获利的），来论述Dune这个系统多么有价值。最后针对其中三个应用做了比较具体的实现和实验评测。

#### Mars Code阅读笔记

本文由NASA喷射推进实验室的高级研究科学家和研究员Gerard J. Holzmann写作，他主要回顾了2012年“好奇号”登陆火星进行科学探测项目背后的JPL飞行软件团队为了提高软件可靠性采取的一系列预防措施。

文章中提出了几个重要的观点：星际飞船控制软件必须具有高标准的软件可靠性；硬件和软件方面均需采取措施确保航天器可靠运行，并且系统能够远程地调试和修复；形式化方法有助于验证复杂软件系统中的竞争条件、死锁等问题，而模型检查技术可以自动化地实现这种验证过程。

不同的软件系统应用于不同的场合，因此也有着不同的设计目标。不同的设计目标意味着不同的权衡和折衷。譬如本文中介绍的航天器控制系统，其最重要的设计目标是可靠性。这是因为航天器升空、航行、探测器着陆这些过程只会进行一次，只有一次机会成功，否则就是失败，只能全部重头来过，而失败的代价非常高昂（其意味着巨大的资产损失、负责机构的声誉污点，和人类错失了一次宝贵的探索宇宙的机会）。如此追求可靠性带来的负面影响在我看来应该是人力成本、时间成本（软件开发周期长，效率低）。不过我觉得一次航天任务、火星探测任务顺利成功执行带来的收益必然是远高于这些成本投入的。

可靠性的关键无非在于两点，一是开发（尽量避免写出低可靠性的软件），二是测试（如何找出、修正软件中有漏洞的地方）。

在开发方面，除了通常的软件开发方法外，开发团队采用了特别制定的代码编写规范，这些规范每一条都和历史任务中观测到的风险有直接关联，并且这些规范都能够通过工具来自动检查。对于不同重要性的代码，代码规范有不同的标准，分成了LOC1-LOC6（level of codes）。我印象比较深刻的标准是最低标准LOC-1中一条规则要求所有的代码编译的时候（开启所有警报）不能报警报（Warning）。

所有的代码规范必须被遵循（通过检查器来检查），软件开发者也必须经过培训和考核认证。

在测试方面，Holzmann着重强调静态源码分析、持续进行的集成测试、工具化的代码审查、彻底的测试和逻辑验证。在Hozemann给的talk中他展示了他们团队开发的工具Scrub。所有代码既会被peer review，也会同时被多个不同的代码检查工具进行形式化地检验。所以的问题都会反馈给开发者，而开发者必需显示地进行回应（不回应默认是承认代码有问题需要修改）。代码审查的流程非常严格，但这也最大程度地保障了软件的正确性和可靠性。

火星探测器软件中最难定位的bug大概是和多线程相关的问题，比如race condition、死锁问题等等。“好奇号”的系统中有多达120个并行的线程，无死锁，无竞争条件非常重要。我在以前学习操作系统时了解过priority inversion，这个问题在1997年的美国的火星探测器的系统中就出现过。大致是低优先级的任务获得了互斥锁在关键区域中，但一直无法得到CPU资源（CPU一直被另一个高优先级任务占用）释放锁，导致一个更高优先级的重要任务无法进入关键区域。

JPL开发团队采用模型检查的工具来对多线程程序进行测试，例如测试证明零死锁，和所有的assertion语句都成立、有效等等。这种利用模型提取工具和模型检查工具对软件进行测试的方法可以极大的减少多线程bug的出现，而且效率非常高。

火星探测器的特殊之处在于它的开发环境和实际使用环境截然不同，所以很难实际地构造它被使用的真实环境，对系统软件进行反复的测试。因此，不仅在开发阶段就要采取措施尽量避免bug的引入，也要在火星探测器升空之前，对其系统进行各种模拟，各种彻底的测试。本文介绍了这些过程中的一些有效的方法和工具，显示了形式化方法、工具测试、模型检查等方法对于开发高可靠性软件的重要性。

